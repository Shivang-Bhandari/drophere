// Generated by CoffeeScript 1.4.0
var Uploader, handle_drag_enter, handle_drag_leave, handle_drag_over, handle_drop, root,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

root = typeof exports !== "undefined" && exports !== null ? exports : this;

Uploader = (function() {

  function Uploader(file, progress_bar, message) {
    this.file = file;
    this.progress_bar = progress_bar;
    this.message = message;
    this.upload_complete = __bind(this.upload_complete, this);

    this.update_progress = __bind(this.update_progress, this);

    this._bar = this.progress_bar.find('.bar');
  }

  Uploader.prototype.error_handler = function(evt) {
    switch (evt.target.error.code) {
      case evt.target.error.NOT_FOUND_ERR:
        return alert('File Not Found.');
      case evt.target.error.NOT_READABLE_ERR:
        return alert('File is not readable.');
      case evt.target.error.ABORT_ERR:
        return null;
      default:
        return alert('An error occurred reading this file.');
    }
  };

  Uploader.prototype._update_progress_bar = function(percent) {
    return this._bar.width("" + percent + "%");
  };

  Uploader.prototype.update_progress = function(evt) {
    var percent_loaded;
    if (evt.lengthComputable) {
      percent_loaded = Math.round((evt.loaded / evt.total) * 100);
      if (percent_loaded < 100) {
        console.log("" + percent_loaded + "%");
        return this._update_progress_bar(percent_loaded);
      }
    }
  };

  Uploader.prototype.upload_complete = function(data) {
    this._update_progress_bar(100);
    console.log(data);
    return this.progress_bar.removeClass('active');
  };

  Uploader.prototype.upload = function() {
    var ajax_params, form_data;
    form_data = new FormData;
    form_data.append(this.file.name, this.file);
    ajax_params = {
      type: 'POST',
      url: '/upload',
      data: form_data,
      contentType: false,
      processData: false,
      progress: this.update_progress,
      success: this.upload_complete
    };
    $.ajax(ajax_params);
    return null;
  };

  return Uploader;

})();

handle_drag_over = function(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  return evt.originalEvent.dataTransfer.dropEffect = 'copy';
};

handle_drop = function(evt) {
  var file, file_el, file_html, files, message, progress_bar, _i, _len, _results;
  evt.stopPropagation();
  evt.preventDefault();
  drop_zone.removeClass('drag-active');
  files = evt.originalEvent.dataTransfer.files;
  console.log(files);
  _results = [];
  for (_i = 0, _len = files.length; _i < _len; _i++) {
    file = files[_i];
    root.file = file;
    file.id = new Date().getTime();
    file_html = "        <div id=\"file-" + file.name + "-" + file.id + "\" class=\"file media\">            <div class=\"media-body\">                <h4 class=\"media-heading\">" + file.name + "</h4>                <div class=\"message pull-left\">Some message</div>                <br>                <div class=\"progress-bar progress progress-striped\">                    <div class=\"bar\"></div>                </div>            </div>        </div><hr>";
    $('#output').append(file_html);
    file_el = document.getElementById("file-" + file.name + "-" + file.id);
    progress_bar = $(file_el).find('.progress-bar');
    message = $(file_el).find('.message');
    root.uploader = new Uploader(file, progress_bar, message);
    _results.push(uploader.upload());
  }
  return _results;
};

handle_drag_enter = function(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  console.log('enter');
  return drop_zone.addClass('drag-active');
};

handle_drag_leave = function(evt) {
  evt.stopPropagation();
  evt.preventDefault();
  console.log('leave');
  if (evt.srcElement === drop_mask.get(0)) {
    console.log(evt);
    return drop_zone.removeClass('drag-active');
  }
};

window.onready = function() {
  if (!(window.File && window.FileReader && window.FileList && window.Blob && window.FormData)) {
    alert('APIs are not supported');
    null;
  }
  root.drop_zone = $("#drop-zone");
  root.drop_mask = $("#drop-zone #drop-mask");
  drop_zone.bind('dragenter', handle_drag_enter);
  drop_zone.bind('dragleave', handle_drag_leave);
  drop_zone.bind('dragover', handle_drag_over);
  return drop_zone.bind('drop', handle_drop);
};
